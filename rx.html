<!-- /rx.html -->
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è™•æ–¹æŸ¥è©¢ï½œå¾å®¶è—¥å±€</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <div class="max-w-md mx-auto p-4">
    <!-- Header -->
    <header class="text-center my-6">
      <h1 class="text-3xl font-extrabold tracking-tight text-gray-900">è™•æ–¹æŸ¥è©¢</h1>
      <p id="welcome" class="text-gray-500 mt-2"></p>
    </header>

    <!-- Actions -->
    <div class="flex items-center gap-2 mb-4">
      <button id="refreshBtn" class="flex-1 rounded-xl px-4 py-3 bg-green-600 text-white font-semibold shadow hover:opacity-90">é‡æ–°æ•´ç†</button>
      <button id="toggleAllBtn" class="rounded-xl px-4 py-3 bg-emerald-50 text-emerald-700 font-semibold border border-emerald-200">æ”¶åˆå…¨éƒ¨</button>
      <button id="closeBtn" class="rounded-xl px-4 py-3 bg-gray-200 text-gray-700 font-medium">é—œé–‰è¦–çª—</button>
    </div>

    <!-- Loading -->
    <div id="loading" class="rounded-2xl bg-white shadow p-6 flex items-center justify-center">
      <div class="animate-pulse text-gray-400">è¼‰å…¥ä¸­â‹¯</div>
    </div>

    <!-- Empty -->
    <div id="empty" class="hidden rounded-2xl bg-white shadow p-6 text-center">
      <div class="text-3xl mb-2">ğŸ”</div>
      <p class="text-gray-700 font-medium">å°šæœªæ‰¾åˆ°è™•æ–¹è³‡æ–™</p>
      <p class="text-gray-500 text-sm mt-1">è‹¥å‰›ç¶å®šï¼Œç¨ç­‰å¹¾åˆ†é˜å†è©¦ï¼›æˆ–åˆ°ã€Œä¿®æ”¹é›»è©±ã€ç¢ºèªè³‡è¨Šã€‚</p>
      <a id="toProfile" class="inline-block mt-4 text-green-600 font-semibold underline">å‰å¾€ä¿®æ”¹é›»è©±</a>
    </div>

    <!-- Error -->
    <div id="errorBox" class="hidden rounded-2xl bg-red-50 border border-red-200 p-4 text-red-700"></div>

    <!-- List -->
    <div id="list" class="space-y-4"></div>

    <footer class="text-center text-xs text-gray-400 mt-8 mb-6">
      åƒ…é¡¯ç¤ºä¸Šå€‹æœˆã€æœ¬æœˆã€ä¸‹å€‹æœˆçš„é ˜è—¥è³‡è¨Š
    </footer>
  </div>

<script>
/* ====== Config ====== */
const API = '/api/rx-list';
const LIFF_ID = '2007763002-m2PaWbWe';

/* ====== Utils ====== */
function zhOnly(s){ return String(s || '').replace(/[^\u4E00-\u9FFF]/g, ''); }
function fmtDate(s){
  if (!s) return '-';
  const d = new Date(s);
  if (Number.isNaN(d.getTime())) return s;
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${y}-${m}-${day}`;
}
function isJwt(s){ return /^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+$/.test(s||''); }
function showError(msg){
  const box = document.getElementById('errorBox');
  box.textContent = msg || 'ç™¼ç”ŸéŒ¯èª¤';
  box.classList.remove('hidden');
}

/* ====== Record UI (å»æ‰å·¦ç·šèˆ‡ç¶ é»ï¼Œå¡ç‰‡å‘å·¦è²¼é½Š) ====== */
function recordItem(rec){
  return `
    <div class="bg-white border border-gray-100 rounded-xl shadow-sm p-4">
      <div class="text-gray-900 font-semibold">
        é–‹ç«‹ ${fmtDate(rec.rcp_date)} ãƒ» é ˜è—¥ ${fmtDate(rec.pre_date)}
      </div>
      <div class="text-gray-500 mt-1">
        â€” æœ¬æ¬¡é ˜è—¥ <span class="text-emerald-700 font-semibold">ç¬¬${rec.linkno ?? '-' }æ¬¡</span>
        <span class="text-gray-300 px-1">/</span>
        å¯é ˜æ¬¡æ•¸ <span class="text-blue-700 font-semibold">å…±${rec.linkcan ?? '-' }æ¬¡</span>
      </div>
    </div>
  `;
}

/* ====== Person Card ====== */
function personCard(g, index){
  const safeName = zhOnly(g.name) || 'æœªå¡«å§“å';
  // å…ˆ rcp_dateï¼ˆæ—©â†’æ™šï¼‰ï¼Œå† pre_dateï¼ˆæ—©â†’æ™šï¼‰
  const sorted = [...(g.records || [])].sort((a, b) => {
    const ar = new Date(a.rcp_date).getTime() || 0;
    const br = new Date(b.rcp_date).getTime() || 0;
    if (ar !== br) return ar - br;
    const ap = new Date(a.pre_date).getTime() || 0;
    const bp = new Date(b.pre_date).getTime() || 0;
    return ap - bp;
  });

  const openAttr = 'data-open="1"';
  return `
    <section class="bg-white rounded-2xl shadow overflow-hidden" ${openAttr} id="sec-${index}">
      <!-- Header -->
      <button class="w-full text-left px-4 py-3 flex items-center justify-between bg-gray-50 group" data-role="toggle">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 rounded-full bg-emerald-50 text-emerald-700 grid place-items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4S14.21 4 12 4 8 5.79 8 8s1.79 4 4 4Zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4Z"/></svg>
          </div>
          <div>
            <div class="font-bold text-gray-900 text-lg">${safeName}</div>
            <div class="text-xs text-gray-500">å…± ${sorted.length} ç­†</div>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <span class="text-emerald-700 bg-emerald-50 border border-emerald-200 rounded-full px-3 py-1 text-xs font-semibold" data-role="pill">æ”¶åˆ</span>
          <svg data-role="chev" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-400 transition-transform" viewBox="0 0 24 24" fill="currentColor"><path d="M7.41 8.59 12 13.17l4.59-4.58L18 10l-6 6-6-6z"/></svg>
        </div>
      </button>

      <!-- Records (æ”¹æˆç°¡å–®ç›´å‘åˆ—è¡¨ï¼Œå»æ‰å·¦é‚Šç›´ç·šèˆ‡åœ“é») -->
      <div class="px-4 py-3">
        <div class="space-y-3" data-role="list">
          ${sorted.map(recordItem).join('')}
        </div>
      </div>
    </section>
  `;
}

/* ====== Render ====== */
function renderGroups(groups){
  const list = document.getElementById('list');
  list.innerHTML = groups.map(personCard).join('');

  // ç¶å®šæ¯å€‹ section çš„å±•é–‹/æ”¶åˆ
  list.querySelectorAll('section').forEach(sec => {
    const btn = sec.querySelector('[data-role="toggle"]');
    const listEl = sec.querySelector('[data-role="list"]');
    const pill = sec.querySelector('[data-role="pill"]');
    const chev = sec.querySelector('[data-role="chev"]');

    function updateUI(){
      const isOpen = sec.getAttribute('data-open') === '1';
      listEl.classList.toggle('hidden', !isOpen);
      pill.textContent = isOpen ? 'æ”¶åˆ' : 'å±•é–‹';
      chev.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(-90deg)';
    }
    btn.addEventListener('click', () => {
      const now = sec.getAttribute('data-open') === '1' ? '0' : '1';
      sec.setAttribute('data-open', now);
      updateUI();
      updateToggleAllBtnLabel();
    });
    updateUI();
  });

  updateToggleAllBtnLabel();
}

/* ====== Toggle All ====== */
function areAllOpen(){
  return Array.from(document.querySelectorAll('#list section'))
    .every(sec => sec.getAttribute('data-open') === '1');
}
function setAll(open){
  document.querySelectorAll('#list section').forEach(sec => {
    sec.setAttribute('data-open', open ? '1' : '0');
    const listEl = sec.querySelector('[data-role="list"]');
    const pill = sec.querySelector('[data-role="pill"]');
    const chev = sec.querySelector('[data-role="chev"]');
    listEl.classList.toggle('hidden', !open);
    pill.textContent = open ? 'æ”¶åˆ' : 'å±•é–‹';
    chev.style.transform = open ? 'rotate(0deg)' : 'rotate(-90deg)';
  });
}
function updateToggleAllBtnLabel(){
  const btn = document.getElementById('toggleAllBtn');
  btn.textContent = areAllOpen() ? 'æ”¶åˆå…¨éƒ¨' : 'å±•é–‹å…¨éƒ¨';
}

/* ====== Auth ====== */
async function getIdTokenEnsured(){
  if (!liff.isLoggedIn()) await liff.login({ scope:['openid','profile'] });
  let t = liff.getIDToken();
  if (!isJwt(t)) {
    await liff.login({ scope:['openid','profile'], prompt:'consent' });
    t = liff.getIDToken();
  }
  return t;
}

/* ====== Fetch ====== */
async function fetchData(){
  const loading = document.getElementById('loading');
  const empty = document.getElementById('empty');
  document.getElementById('errorBox').classList.add('hidden');
  loading.classList.remove('hidden');
  empty.classList.add('hidden');

  try{
    const idToken = await getIdTokenEnsured();
    if (!isJwt(idToken)) {
      showError('å–å¾— id_token å¤±æ•—ï¼ˆä¸æ˜¯ JWTï¼‰ã€‚è«‹ç¢ºèª LIFF scopes æœ‰ openid/profileã€‚');
      return;
    }

    const r = await fetch(API, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ id_token: idToken })
    });
    const data = await r.json();

    if (!r.ok) {
      const msg = [data.error, data.detail].filter(Boolean).join(': ') || 'æŸ¥è©¢å¤±æ•—';
      throw new Error(msg);
    }

    if (!data.groups?.length) {
      empty.classList.remove('hidden');
      document.getElementById('list').innerHTML = '';
    } else {
      renderGroups(data.groups);
    }
  } catch(e){
    showError(e.message || 'ç™¼ç”ŸéŒ¯èª¤');
  } finally {
    loading.classList.add('hidden');
  }
}

/* ====== Boot ====== */
async function main(){
  await liff.init({ liffId: LIFF_ID });
  try {
    const p = await liff.getProfile();
    document.getElementById('welcome').innerHTML =
      `ğŸ‘‹ å“ˆå›‰ï¼Œ<span class="text-green-600 font-semibold">${p.displayName}</span>`;
  } catch {}
  document.getElementById('toProfile')?.setAttribute('href', `https://liff.line.me/${LIFF_ID}?path=profile`);
  await fetchData();
}

/* ====== Events ====== */
document.getElementById('refreshBtn').addEventListener('click', fetchData);
document.getElementById('closeBtn').addEventListener('click', ()=>{
  if (liff.isInClient()) liff.closeWindow(); else window.close();
});
document.getElementById('toggleAllBtn').addEventListener('click', ()=>{
  setAll(!areAllOpen());
  updateToggleAllBtnLabel();
});

main();
</script>
</body>
</html>
