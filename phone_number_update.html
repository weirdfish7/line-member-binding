<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ä¿®æ”¹é›»è©±è™Ÿç¢¼ï½œå¾å®¶è—¥å±€</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- Supabase JS v2 -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    /* ====== 1) ç’°å¢ƒè®Šæ•¸ï¼ˆæ”¹æˆä½ çš„ï¼‰ ====== */
    const LIFF_ID            = "2007763002-OAGeQLQ3";
    const SUPABASE_URL       = "https://cbjvorfvohqulwbbcnfb.supabase.co";
    const SUPABASE_ANON_KEY  = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNianZvcmZ2b2hxdWx3YmJjbmZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzNTQyNzYsImV4cCI6MjA2ODkzMDI3Nn0.lNQCZ6uJd1NQjMCiotjS69ylpyhaVSD6fsnrwLbFooM";
    const REGISTER_URL       = "https://your-register-page.example.com"; // ä½ æ—¢æœ‰çš„ç¶å®šé 

    /* ====== 2) Supabase Client ====== */
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* ====== 3) ç°¡æ˜“ i18n ====== */
    const I18N = {
      "zh": {
        brand: "å¾å®¶è—¥å±€ æœƒå“¡é©—è­‰",
        hi: "å“ˆå›‰ï¼Œ",
        notMember: "æ‚¨é‚„ä¸æ˜¯å¾å®¶æœƒå“¡",
        notMemberDesc: "è«‹å…ˆå®Œæˆæœƒå“¡ç¶å®šå¾Œå†å›ä¾†ä¿®æ”¹é›»è©±è™Ÿç¢¼ã€‚",
        goBind: "å‰å¾€ç¶å®šè¨»å†Š",
        inputPhone: "è«‹è¼¸å…¥æ–°é›»è©±",
        tip: "ï¼ˆå°‡åªä¿ç•™æ•¸å­—ï¼Œä¾‹ï¼š0912345678ï¼‰",
        save: "å„²å­˜ä¸¦é—œé–‰",
        saving: "å„²å­˜ä¸­...",
        saved: "å·²æ›´æ–°é›»è©±è™Ÿç¢¼",
        loadFail: "è®€å–è³‡æ–™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦",
        emptyPhone: "è«‹è¼¸å…¥æ–°é›»è©±",
        samePhone: "é›»è©±æœªè®Šæ›´",
        welcome: "æœƒå“¡é›»è©±ä¿®æ”¹",
        bye: "æ­£åœ¨é—œé–‰è¦–çª—â€¦",
        currentPhone: "ç›®å‰é›»è©±",
      },
      "en": {
        brand: "Wujia Pharmacy Member",
        hi: "Hi, ",
        notMember: "You're not a member yet",
        notMemberDesc: "Please complete binding/registration before editing your phone number.",
        goBind: "Go to register",
        inputPhone: "Enter new phone number",
        tip: "(Digits only will be saved, e.g. 0912345678)",
        save: "Save & close",
        saving: "Saving...",
        saved: "Phone updated",
        loadFail: "Failed to load. Please try again.",
        emptyPhone: "Please enter a phone number",
        samePhone: "No change",
        welcome: "Edit Phone Number",
        bye: "Closing windowâ€¦",
        currentPhone: "Current phone",
      },
    };
    const pickLang = () => (navigator.language?.startsWith("zh") ? "zh" : "en");

    /* ====== 4) å°å·¥å…· ====== */
    const $ = (sel) => document.querySelector(sel);
    const digitsOnly = (v) => (String(v || "").match(/\d+/g) || []).join("");

    /* ====== 5) UI ç¶å®š ====== */
    const ui = {
      card:      () => $("#card"),
      loading:   () => $("#loading"),
      errorBox:  () => $("#errorBox"),
      noti:      () => $("#noti"),
      nameSpan:  () => $("#lineName"),
      phoneNow:  () => $("#phoneNow"),
      phoneInput:() => $("#phoneInput"),
      saveBtn:   () => $("#saveBtn"),
      bindBtn:   () => $("#bindBtn"),
      notMember: () => $("#notMember"),
      editor:    () => $("#editor"),
      langBtn:   () => $("#langBtn"),
      title:     () => $("#title"),
      subtitle:  () => $("#subtitle"),
      tip:       () => $("#tip"),
      lblCurrent:() => $("#lblCurrent"),
    };

    /* ====== 6) ç‹€æ…‹ ====== */
    let lang = pickLang();
    let uid  = "";
    let displayName = "";
    let originalPhone = "";

    function applyI18n() {
      const t = I18N[lang];
      document.title         = t.welcome + "ï½œ" + t.brand;
      ui.title().textContent = t.welcome;
      ui.subtitle().innerHTML = `ğŸ‘‹ ${t.hi}<span id="lineName" class="text-green-600 font-semibold"></span>ï¼`;
      ui.tip().textContent   = t.tip;
      ui.saveBtn().textContent = t.save;
      ui.bindBtn().textContent = t.goBind;
      ui.lblCurrent().textContent = t.currentPhone;
      ui.langBtn().textContent = lang === "zh" ? "EN" : "ä¸­";
      // not-member card
      $("#nmTitle").textContent = t.notMember;
      $("#nmDesc").textContent  = t.notMemberDesc;
      // placeholders
      ui.phoneInput().placeholder = t.inputPhone;
    }

    function setLoading(on) {
      ui.loading().classList.toggle("hidden", !on);
      ui.card().classList.toggle("hidden", on);
    }

    function toast(msg) {
      const el = ui.noti();
      el.textContent = msg;
      el.classList.remove("opacity-0","translate-y-2");
      setTimeout(() => {
        el.classList.add("opacity-0","translate-y-2");
      }, 1800);
    }

    function setSaveBtnState() {
      const t = I18N[lang];
      const v = digitsOnly(ui.phoneInput().value);
      ui.saveBtn().disabled = !v || v === originalPhone;
      ui.saveBtn().title = !v ? t.emptyPhone : (v === originalPhone ? t.samePhone : "");
    }

    /* ====== 7) åˆå§‹åŒ–æµç¨‹ ====== */
    async function main() {
      applyI18n();
      ui.langBtn().addEventListener("click", () => {
        lang = (lang === "zh" ? "en" : "zh");
        applyI18n();
        // å¡«å›åå­—
        ui.nameSpan().textContent = displayName || "";
      });

      ui.phoneInput().addEventListener("input", () => {
        // åƒ…ä¿ç•™æ•¸å­—ï¼Œä½†ä¸å¼·åˆ¶æ”¹è®Šæ¸¸æ¨™é«”é©—ï¼šé¡¯ç¤ºå±¤ä¿ç•™åŸæ¨£ï¼Œå­˜æª”æ™‚å†è¦æ•´
        setSaveBtnState();
      });

      ui.bindBtn().addEventListener("click", () => {
        location.href = REGISTER_URL;
      });

      ui.saveBtn().addEventListener("click", onSave);

      try {
        setLoading(true);

        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const profile = await liff.getProfile();
        uid = profile.userId;
        displayName = profile.displayName || "";
        ui.nameSpan().textContent = displayName;

        // è®€å–æ­¤ uid çš„æœƒå“¡è³‡æ–™
        const { data, error } = await sb
          .from("users")
          .select("id, uid, display_name, phone")
          .eq("uid", uid)
          .maybeSingle();

        if (error) {
          console.error(error);
          throw error;
        }

        const t = I18N[lang];

        if (!data || !data.phone) {
          // éæœƒå“¡æˆ–å°šæœªç¶å®šé›»è©±
          $("#nmCard").classList.remove("hidden");
          ui.editor().classList.add("hidden");
        } else {
          // å·²æœ‰æœƒå“¡è³‡æ–™ â†’ é¡¯ç¤ºç·¨è¼¯
          $("#nmCard").classList.add("hidden");
          ui.editor().classList.remove("hidden");

          originalPhone = digitsOnly(data.phone);
          ui.phoneNow().textContent = originalPhone || "-";
          ui.phoneInput().value = originalPhone;
          setSaveBtnState();
        }
      } catch (e) {
        console.error(e);
        ui.errorBox().classList.remove("hidden");
        ui.errorBox().textContent = I18N[lang].loadFail;
      } finally {
        setLoading(false);
      }
    }

    /* ====== 8) é€å‡ºæ›´æ–° ====== */
    async function onSave() {
      const t = I18N[lang];
      const raw = ui.phoneInput().value;
      const phone = digitsOnly(raw);

      if (!phone) {
        toast(t.emptyPhone);
        return;
      }
      if (phone === originalPhone) {
        toast(t.samePhone);
        return;
      }

      ui.saveBtn().disabled = true;
      ui.saveBtn().textContent = t.saving;

      try {
        const { error } = await sb
          .from("users")
          .update({ phone })
          .eq("uid", uid);

        if (error) throw error;

        toast(t.saved);
        // ç¨å¾…ä¸€ä¸‹ä»¥ä¾¿ä½¿ç”¨è€…çœ‹åˆ°é€šçŸ¥ï¼Œå†é—œé–‰ LIFF
        setTimeout(() => {
          $("#closing").classList.remove("hidden");
          $("#closingMsg").textContent = t.bye;
          liff.closeWindow();
        }, 600);
      } catch (e) {
        console.error(e);
        toast("Error: " + (e?.message || "update failed"));
      } finally {
        ui.saveBtn().textContent = t.save;
        setSaveBtnState();
      }
    }

    window.addEventListener("DOMContentLoaded", main);
  </script>
</head>

<body class="bg-gray-50 min-h-screen flex items-start justify-center">
  <!-- é€šçŸ¥ -->
  <div id="noti"
       class="fixed top-4 left-1/2 -translate-x-1/2 px-4 py-2 bg-black/80 text-white text-sm rounded-lg transition-all duration-300 opacity-0 translate-y-2 z-50">
  </div>

  <!-- Loading -->
  <div id="loading" class="mt-24 text-gray-500 text-sm hidden">
    <svg class="animate-spin h-6 w-6 mx-auto mb-4" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
    </svg>
    Loading...
  </div>

  <!-- Card -->
  <div id="card" class="w-full max-w-md mx-4 mt-10 mb-16">
    <div class="bg-white shadow-xl rounded-3xl p-6 md:p-7">
      <div class="flex items-center justify-between mb-2">
        <h1 id="title" class="text-2xl md:text-3xl font-extrabold tracking-tight text-gray-800">æœƒå“¡é›»è©±ä¿®æ”¹</h1>
        <button id="langBtn" class="text-gray-400 hover:text-gray-700 text-sm px-2 py-1 rounded-md border border-gray-200">EN</button>
      </div>

      <p id="subtitle" class="text-gray-700 mt-1">
        ğŸ‘‹ å“ˆå›‰ï¼Œ<span id="lineName" class="text-green-600 font-semibold"></span>ï¼
      </p>

      <p class="text-xs text-red-500 mt-2" id="tip">ï¼ˆå°‡åªä¿ç•™æ•¸å­—ï¼Œä¾‹ï¼š0912345678ï¼‰</p>

      <!-- æœªç¶å®šæé†’ -->
      <div id="nmCard" class="mt-6 hidden">
        <div class="rounded-2xl border border-amber-200 bg-amber-50 p-4">
          <div class="font-semibold text-amber-800 text-lg" id="nmTitle">æ‚¨é‚„ä¸æ˜¯å¾å®¶æœƒå“¡</div>
          <div class="text-amber-700 text-sm mt-1" id="nmDesc">
            è«‹å…ˆå®Œæˆæœƒå“¡ç¶å®šå¾Œå†å›ä¾†ä¿®æ”¹é›»è©±è™Ÿç¢¼ã€‚
          </div>
          <button id="bindBtn"
            class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white rounded-xl font-semibold py-3">
            å‰å¾€ç¶å®šè¨»å†Š
          </button>
        </div>
      </div>

      <!-- ç·¨è¼¯å€ -->
      <div id="editor" class="mt-6">
        <label class="block text-sm text-gray-500 mb-1" id="lblCurrent">ç›®å‰é›»è©±</label>
        <div class="px-3 py-2 bg-gray-50 border rounded-xl text-gray-700" id="phoneNow">-</div>

        <div class="mt-4">
          <input id="phoneInput" type="tel" inputmode="numeric" maxlength="20"
                 placeholder="è«‹è¼¸å…¥æ–°é›»è©±"
                 class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none" />
        </div>

        <button id="saveBtn"
          class="mt-6 w-full bg-green-600 disabled:opacity-40 hover:bg-green-700 text-white rounded-xl font-semibold py-3"
          disabled>å„²å­˜ä¸¦é—œé–‰</button>
      </div>

      <div id="closing" class="hidden text-center text-gray-500 text-sm mt-4">
        <span id="closingMsg">æ­£åœ¨é—œé–‰è¦–çª—â€¦</span>
      </div>

      <div id="errorBox" class="hidden mt-4 text-sm text-red-600"></div>
    </div>
  </div>
</body>
</html>
