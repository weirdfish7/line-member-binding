<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>æ‰“å¡é é¢</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="p-6 bg-gray-100">

  <div id="loading" class="text-lg">ğŸ”„ è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</div>

  <div id="main" class="hidden space-y-4">
    <div class="text-xl font-bold">ğŸ‘¤ ä½¿ç”¨è€…ï¼š<span id="lineName"></span></div>

    <div id="punchButtons" class="space-x-4">
      <button id="punchInBtn" onclick="punch('in')" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">ä¸Šç­æ‰“å¡</button>
      <button id="punchOutBtn" onclick="punch('out')" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700">ä¸‹ç­æ‰“å¡</button>
    </div>

    <div id="message" class="text-lg font-medium text-gray-800"></div>

    <button onclick="closeWindow()" class="mt-6 px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500">âŒ é—œé–‰</button>
  </div>

  <script>
    window.onload = async function () {
      const SUPABASE_URL = 'https://ucrgtvmwgexwctixabgi.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjcmd0dm13Z2V4d2N0aXhhYmdpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4MDQ1MTMsImV4cCI6MjA2ODM4MDUxM30.cAbecnHr3R2deyQfTcP5-S-PDcBkNVhD3TleMQsgoAo';

      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      let profile;
      let userId;
      let lastPunchType;

      async function init() {
        try {
          await liff.init({ liffId: "2007763002-9GM3O8OP" });

          if (!liff.isLoggedIn()) {
            liff.login();
            return;
          }

          profile = await liff.getProfile();
          document.getElementById("lineName").textContent = profile.displayName;

          // æŸ¥è©¢ä½¿ç”¨è€…æ˜¯å¦ç¶å®š
          const { data: user, error: findErr } = await supabase
            .from("users")
            .select("id")
            .eq("uid", profile.userId)
            .single();

          if (findErr || !user) {
            document.getElementById("loading").textContent = "âš ï¸ å°šæœªå®Œæˆæœƒå“¡ç¶å®šï¼Œè«‹å¾åœ–æ–‡é¸å–®é‡æ–°é€²å…¥";
            return;
          }

          userId = user.id;

          // æŸ¥è©¢æœ€å¾Œæ‰“å¡
          const { data: last, error: lastErr } = await supabase
            .from("punch_logs")
            .select("punch_type")
            .eq("user_id", userId)
            .order("punched_at", { ascending: false })
            .limit(1)
            .single();

          lastPunchType = last?.punch_type || null;

          // æ ¹æ“šç‹€æ…‹æ§åˆ¶æŒ‰éˆ•
          const inBtn = document.getElementById("punchInBtn");
          const outBtn = document.getElementById("punchOutBtn");

          if (lastPunchType === 'ä¸Šç­') {
            inBtn.disabled = true;
            inBtn.classList.add("opacity-40");
          } else if (lastPunchType === 'ä¸‹ç­') {
            outBtn.disabled = true;
            outBtn.classList.add("opacity-40");
          }

          document.getElementById("loading").classList.add("hidden");
          document.getElementById("main").classList.remove("hidden");

        } catch (error) {
          document.getElementById("loading").textContent = "åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
          console.error("LIFF Init Error:", error);
        }
      }

      window.punch = async function (type) {
        document.getElementById("message").textContent = type === 'in' ? 'ä¸Šç­æ‰“å¡ä¸­â€¦' : 'ä¸‹ç­æ‰“å¡ä¸­â€¦';

        const targetType = type === 'in' ? 'ä¸Šç­' : 'ä¸‹ç­';

        if (
          (targetType === 'ä¸Šç­' && lastPunchType === 'ä¸Šç­') ||
          (targetType === 'ä¸‹ç­' && lastPunchType === 'ä¸‹ç­')
        ) {
          document.getElementById("message").textContent = `âš ï¸ å·²ç¶“æ‰“é${targetType}å¡ï¼Œè«‹å‹¿é‡è¤‡æ‰“å¡`;
          return;
        }

        try {
          const { error } = await supabase.from("punch_logs").insert([
            {
              user_id: userId,
              punch_type: targetType,
              note: 'ä¾†è‡ª LIFF æ‰“å¡'
            }
          ]);

          if (error) throw error;

          document.getElementById("punchButtons").classList.add("hidden");
          document.getElementById("message").classList.add("text-2xl", "text-green-700", "font-bold");
          document.getElementById("message").textContent = `âœ… ${targetType}æ‰“å¡å®Œæˆï¼`;

        } catch (error) {
          document.getElementById("message").textContent = "âŒ æ‰“å¡å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
          console.error("æ‰“å¡å¤±æ•—:", error);
        }
      }

      window.closeWindow = function () {
        liff.closeWindow();
      }

      init();
    }
  </script>
</body>
</html>
