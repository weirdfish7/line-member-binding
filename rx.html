<!-- /rx.html -->
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è™•æ–¹æŸ¥è©¢ï½œå¾å®¶è—¥å±€</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <div class="max-w-md mx-auto p-4">
    <header class="text-center my-6">
      <h1 class="text-2xl font-bold">è™•æ–¹æŸ¥è©¢</h1>
      <p id="welcome" class="text-gray-500 mt-1"></p>
    </header>

    <div class="flex items-center gap-2 mb-4">
      <button id="refreshBtn" class="flex-1 rounded-xl px-4 py-3 bg-green-500 text-white font-semibold shadow hover:opacity-90">é‡æ–°æ•´ç†</button>
      <button id="closeBtn" class="rounded-xl px-4 py-3 bg-gray-200 text-gray-700 font-medium">é—œé–‰è¦–çª—</button>
    </div>

    <div id="loading" class="rounded-2xl bg-white shadow p-6 flex items-center justify-center">
      <div class="animate-pulse text-gray-400">è¼‰å…¥ä¸­â‹¯</div>
    </div>

    <div id="empty" class="hidden rounded-2xl bg-white shadow p-6 text-center">
      <div class="text-3xl mb-2">ğŸ”</div>
      <p class="text-gray-700 font-medium">å°šæœªæ‰¾åˆ°è™•æ–¹è³‡æ–™</p>
      <p class="text-gray-500 text-sm mt-1">è‹¥å‰›ç¶å®šï¼Œç¨ç­‰å¹¾åˆ†é˜å†è©¦ï¼›æˆ–åˆ°ã€Œä¿®æ”¹é›»è©±ã€ç¢ºèªè³‡è¨Šã€‚</p>
      <a id="toProfile" class="inline-block mt-4 text-green-600 font-semibold underline">å‰å¾€ä¿®æ”¹é›»è©±</a>
    </div>

    <div id="errorBox" class="hidden rounded-2xl bg-red-50 border border-red-200 p-4 text-red-700"></div>
    <div id="list" class="space-y-3"></div>

    <footer class="text-center text-xs text-gray-400 mt-8 mb-6">
      åƒ…é¡¯ç¤ºï¼šå§“åã€è™•æ–¹æ—¥æœŸã€é ˜è—¥æ—¥æœŸã€å¯é ˜æ¬¡æ•¸ã€æœ¬æ¬¡
    </footer>
  </div>

<script>
const API = '/api/rx-list';
const LIFF_ID = '2007763002-m2PaWbWe';  // ä½ çš„

function fmtDate(s){ if(!s) return '-'; const d=new Date(s); if(Number.isNaN(d.getTime())) return s;
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
function chip(v){ return `<span class="inline-block px-2 py-0.5 rounded-full bg-gray-100 text-gray-700 text-xs font-semibold">${v ?? '-'}</span>`; }

function row(it){ return `
  <div class="grid grid-cols-2 gap-2 text-sm py-2 border-b last:border-b-0 border-gray-100">
    <div class="text-gray-500">è™•æ–¹æ—¥æœŸ</div><div class="text-gray-800">${fmtDate(it.rcp_date)}</div>
    <div class="text-gray-500">é ˜è—¥æ—¥æœŸ</div><div class="text-gray-800">${fmtDate(it.pre_date)}</div>
    <div class="text-gray-500">å¯é ˜æ¬¡æ•¸</div><div class="text-gray-800">${chip(it.linkcan)}</div>
    <div class="text-gray-500">æœ¬æ¬¡</div><div class="text-gray-800">${chip(it.linkno)}</div>
  </div>`; }

function renderGroups(groups){
  const list=document.getElementById('list');
  list.innerHTML = groups.map(g=>`
    <section class="bg-white rounded-2xl shadow overflow-hidden">
      <button class="w-full text-left px-4 py-3 flex items-center justify-between bg-gray-50">
        <div class="font-semibold text-gray-800">ğŸ‘¤ ${g.name}</div>
        <div class="text-xs text-gray-500">${g.records.length} ç­†</div>
      </button>
      <div class="px-4 pb-3 hidden">${g.records.map(row).join('')}</div>
    </section>`).join('');
  Array.from(list.querySelectorAll('section > button')).forEach(btn=>{
    const panel=btn.nextElementSibling; btn.addEventListener('click', ()=>panel.classList.toggle('hidden'));
  });
}

function showError(msg){ const box=document.getElementById('errorBox'); box.textContent=msg||'ç™¼ç”ŸéŒ¯èª¤'; box.classList.remove('hidden'); }

function isJwt(s){ return /^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+$/.test(s||''); }

async function getIdTokenEnsured(){
  // 1) æ²’ç™»å…¥å°±ä»¥ openid/profile ç™»å…¥
  if (!liff.isLoggedIn()) await liff.login({ scope:['openid','profile'] });
  // 2) å…ˆæ‹¿ä¸€æ¬¡
  let t = liff.getIDToken();
  // 3) é‚„ä¸æ˜¯ JWT â†’ å¼·åˆ¶é‡æ–°æˆæ¬Š
  if (!isJwt(t)) {
    await liff.login({ scope:['openid','profile'], prompt:'consent' });
    t = liff.getIDToken();
  }
  return t;
}

async function fetchData(){
  const loading=document.getElementById('loading'), empty=document.getElementById('empty');
  document.getElementById('errorBox').classList.add('hidden');
  loading.classList.remove('hidden'); empty.classList.add('hidden');

  try{
    const idToken = await getIdTokenEnsured();
    if (!isJwt(idToken)) { showError('å–å¾— id_token å¤±æ•—ï¼ˆä¸æ˜¯ JWTï¼‰ã€‚è«‹ç¢ºèª LIFF scopes æœ‰ openid/profileã€‚'); return; }

    const r = await fetch(API,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id_token: idToken }) });
    const data = await r.json();

    if (!r.ok) {
      // å¾Œç«¯æœƒå› { error, detail, hint }
      const msg = [data.error, data.detail].filter(Boolean).join(': ') || 'æŸ¥è©¢å¤±æ•—';
      throw new Error(msg);
    }

    if (!data.groups?.length){ empty.classList.remove('hidden'); document.getElementById('list').innerHTML=''; }
    else { renderGroups(data.groups); }
  }catch(e){ showError(e.message||'ç™¼ç”ŸéŒ¯èª¤'); }
  finally{ loading.classList.add('hidden'); }
}

async function main(){
  await liff.init({ liffId: LIFF_ID });
  try{ const p=await liff.getProfile(); document.getElementById('welcome').innerHTML=`ğŸ‘‹ å“ˆå›‰ï¼Œ<span class="text-green-600 font-semibold">${p.displayName}</span>`; }catch{}
  document.getElementById('toProfile')?.setAttribute('href', `https://liff.line.me/${LIFF_ID}?path=profile`);
  await fetchData();
}
document.getElementById('refreshBtn').addEventListener('click', fetchData);
document.getElementById('closeBtn').addEventListener('click', ()=>{ if(liff.isInClient()) liff.closeWindow(); else window.close(); });
main();
</script>

</body>
</html>
