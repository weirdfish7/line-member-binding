<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>打卡頁面</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="p-6 bg-gray-100">

  <div id="loading" class="text-lg">🔄 載入中，請稍候...</div>

  <div id="main" class="hidden space-y-4">
    <div class="text-xl font-bold">👤 使用者：<span id="lineName"></span></div>

    <div id="punchButtons" class="space-x-4">
      <button id="punchInBtn" onclick="punch('in')" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">上班打卡</button>
      <button id="punchOutBtn" onclick="punch('out')" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700">下班打卡</button>
    </div>

    <div id="message" class="text-lg font-medium text-gray-800"></div>

    <button onclick="closeWindow()" class="mt-6 px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500">❌ 關閉</button>
  </div>

  <script>
    window.onload = async function () {
      const SUPABASE_URL = 'https://ucrgtvmwgexwctixabgi.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjcmd0dm13Z2V4d2N0aXhhYmdpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4MDQ1MTMsImV4cCI6MjA2ODM4MDUxM30.cAbecnHr3R2deyQfTcP5-S-PDcBkNVhD3TleMQsgoAo';

      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      let profile;
      let userId;
      let lastPunchType;

      async function init() {
        try {
          await liff.init({ liffId: "2007763002-9GM3O8OP" });

          if (!liff.isLoggedIn()) {
            liff.login();
            return;
          }

          profile = await liff.getProfile();
          document.getElementById("lineName").textContent = profile.displayName;

          // 查詢使用者是否綁定
          const { data: user, error: findErr } = await supabase
            .from("users")
            .select("id")
            .eq("uid", profile.userId)
            .single();

          if (findErr || !user) {
            document.getElementById("loading").textContent = "⚠️ 尚未完成會員綁定，請從圖文選單重新進入";
            return;
          }

          userId = user.id;

          // 查詢最後打卡
          const { data: last, error: lastErr } = await supabase
            .from("punch_logs")
            .select("punch_type")
            .eq("user_id", userId)
            .order("punched_at", { ascending: false })
            .limit(1)
            .single();

          lastPunchType = last?.punch_type || null;

          // 根據狀態控制按鈕
          const inBtn = document.getElementById("punchInBtn");
          const outBtn = document.getElementById("punchOutBtn");

          if (lastPunchType === '上班') {
            inBtn.disabled = true;
            inBtn.classList.add("opacity-40");
          } else if (lastPunchType === '下班') {
            outBtn.disabled = true;
            outBtn.classList.add("opacity-40");
          }

          document.getElementById("loading").classList.add("hidden");
          document.getElementById("main").classList.remove("hidden");

        } catch (error) {
          document.getElementById("loading").textContent = "初始化失敗，請稍後再試。";
          console.error("LIFF Init Error:", error);
        }
      }

      window.punch = async function (type) {
        document.getElementById("message").textContent = type === 'in' ? '上班打卡中…' : '下班打卡中…';

        const targetType = type === 'in' ? '上班' : '下班';

        if (
          (targetType === '上班' && lastPunchType === '上班') ||
          (targetType === '下班' && lastPunchType === '下班')
        ) {
          document.getElementById("message").textContent = `⚠️ 已經打過${targetType}卡，請勿重複打卡`;
          return;
        }

        try {
          const { error } = await supabase.from("punch_logs").insert([
            {
              user_id: userId,
              punch_type: targetType,
              note: '來自 LIFF 打卡'
            }
          ]);

          if (error) throw error;

          document.getElementById("punchButtons").classList.add("hidden");
          document.getElementById("message").classList.add("text-2xl", "text-green-700", "font-bold");
          document.getElementById("message").textContent = `✅ ${targetType}打卡完成！`;

        } catch (error) {
          document.getElementById("message").textContent = "❌ 打卡失敗，請稍後再試";
          console.error("打卡失敗:", error);
        }
      }

      window.closeWindow = function () {
        liff.closeWindow();
      }

      init();
    }
  </script>
</body>
</html>
